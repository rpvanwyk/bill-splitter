<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bill Splitter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <!-- Mobile Phone Frame -->
  <div class="w-full max-w-md">
    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden" style="aspect-ratio: 9/19.5; height: 844px; max-height: 90vh;">
      
      <!-- Status Bar -->
      <div class="bg-gray-900 text-white px-6 py-2 flex justify-between items-center text-xs">
        <span>9:41</span>
        <div class="flex gap-1">
          <span>üì∂</span>
          <span>üì°</span>
          <span>üîã</span>
        </div>
      </div>

      <!-- App Header -->
      <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4">
        <h1 class="text-2xl font-bold">Bill Splitter</h1>
        <p class="text-blue-100 text-sm">Scan & split your bills easily</p>
      </div>

      <!-- Main Content -->
      <div class="flex flex-col h-full bg-white overflow-y-auto pb-32" id="mainContent">
        
        <!-- API Key Setup State -->
        <div id="apiKeySetupState" class="flex-1 flex flex-col items-center justify-center p-6">
          <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-6">
            <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
            </svg>
          </div>
          <h2 class="text-xl font-semibold text-gray-800 mb-2">Enter API Key</h2>
          <p class="text-gray-600 text-center mb-6 text-sm">Enter your Anthropic API key to analyze this bill</p>
          
          <div class="w-full max-w-sm mb-4">
            <input 
              type="password" 
              id="apiKeyInput" 
              placeholder="sk-ant-..."
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
            >
          </div>
          
          <button onclick="saveApiKey()" class="bg-blue-600 text-white px-8 py-3 rounded-full font-semibold shadow-lg hover:bg-blue-700 transition-all mb-4">
            Continue
          </button>
          
          <p class="text-xs text-gray-500 text-center mb-4">Your API key is not saved and will be cleared after analysis</p>
          
          <details class="mt-4 w-full max-w-sm">
            <summary class="text-sm text-gray-600 cursor-pointer hover:text-gray-800">How to get an API key?</summary>
            <div class="mt-2 text-xs text-gray-600 bg-gray-50 p-3 rounded-lg">
              <ol class="list-decimal list-inside space-y-1">
                <li>Go to console.anthropic.com</li>
                <li>Create an account and add billing</li>
                <li>Navigate to "API Keys"</li>
                <li>Create a new key and copy it</li>
              </ol>
            </div>
          </details>
        </div>

        <!-- Initial State: Camera Button -->
        <div id="initialState" class="flex-1 flex flex-col items-center justify-center p-6">
          <div class="w-32 h-32 bg-blue-100 rounded-full flex items-center justify-center mb-6">
            <svg class="w-16 h-16 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </div>
          <h2 class="text-xl font-semibold text-gray-800 mb-2">Scan Your Bill</h2>
          <p class="text-gray-600 text-center mb-8">Take a photo of your restaurant bill to get started</p>
          
          <input type="file" id="fileInput" accept="image/*" capture="environment" class="hidden">
          <button onclick="triggerCamera()" class="bg-blue-600 text-white px-8 py-4 rounded-full font-semibold shadow-lg hover:bg-blue-700 transition-all">
            üì∑ Take Photo
          </button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden flex-1 flex flex-col items-center justify-center p-6">
          <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
          <p class="text-gray-600">Analyzing bill...</p>
        </div>

        <!-- Image Management State -->
        <div id="imageManagementState" class="hidden p-6">
          <button onclick="showState('initialState'); resetImages();" class="mb-4 text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1">
            ‚Üê Back
          </button>
          
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Bill Images</h3>
          
          <!-- Uploaded Images Grid -->
          <div id="uploadedImagesGrid" class="grid grid-cols-2 gap-3 mb-4">
            <!-- Uploaded images will appear here -->
          </div>
          
          <!-- Add More Button -->
          <button onclick="triggerCamera()" class="w-full bg-blue-100 border-2 border-dashed border-blue-300 text-blue-600 py-4 rounded-lg font-semibold hover:bg-blue-200 transition-all mb-4">
            + Add Another Image
          </button>
          
          <button onclick="analyzeAllImages()" id="analyzeAllBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
            Analyze All Images
          </button>
        </div>

        <!-- Crop State -->
        <div id="cropState" class="hidden p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Crop Image</h3>
          
          <div class="mb-4 bg-black rounded-lg overflow-hidden" style="max-height: 400px;">
            <img id="cropperImage" style="max-width: 100%;">
          </div>
          
          <div class="flex gap-3">
            <button onclick="cancelCrop()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-all">
              Cancel
            </button>
            <button onclick="saveCrop()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all">
              Save Crop
            </button>
          </div>
        </div>

        <!-- Preview State (REMOVED) -->

        <!-- Results State -->
        <div id="resultsState" class="hidden p-6">
          <button onclick="retakeBill()" class="mb-4 text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1">
            ‚Üê Back
          </button>
          
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Bill Items</h3>
            <div id="billItems" class="space-y-3 mb-4">
              <!-- Items will be inserted here -->
            </div>
            
            <!-- Add Manual Item -->
            <div class="bg-blue-50 border-2 border-dashed border-blue-300 rounded-lg p-3 mb-4">
              <p class="text-sm font-medium text-gray-700 mb-2">Add Manual Item</p>
              <input 
                type="text" 
                id="manualItemName" 
                placeholder="Item name"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2"
              >
              <input 
                type="number" 
                id="manualItemPrice" 
                placeholder="Price"
                step="0.01"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2"
              >
              <input 
                type="number" 
                id="manualItemQty" 
                placeholder="Qty"
                value="1"
                min="1"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2"
              >
              <button onclick="addManualItem()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-all">
                + Add Item
              </button>
            </div>
          </div>
          
          <!-- Bill Total Input -->
          <div class="bg-gray-50 border border-gray-300 rounded-lg p-4 mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Enter Bill Total</label>
            <input 
              type="number" 
              id="billTotalInput" 
              placeholder="0.00"
              step="0.01"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2"
              oninput="validateBillTotal()"
            >
            <div id="totalComparisonMessage" class="text-sm mt-2"></div>
          </div>

          <div class="bg-gray-100 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-center text-lg font-semibold">
              <span>Calculated Total</span>
              <span id="totalAmount">$0.00</span>
            </div>
          </div>

          <button onclick="goToPartySetup()" id="continueToSplitBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
            Continue to Split
          </button>
        </div>

        <!-- Party Setup State -->
        <div id="partySetupState" class="hidden p-6">
          <button onclick="showState('resultsState')" class="mb-4 text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1">
            ‚Üê Back
          </button>
          
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Who's splitting?</h3>
            <p class="text-sm text-gray-600 mb-4">Add people to split the bill</p>
            
            <div class="flex gap-2 mb-4">
              <input 
                type="text" 
                id="personNameInput" 
                placeholder="Enter name"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                onkeypress="if(event.key==='Enter') addPerson()"
              >
              <button onclick="addPerson()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-all text-sm">
                Add
              </button>
            </div>

            <div id="peopleList" class="space-y-2 mb-6">
              <!-- People will be listed here -->
            </div>
          </div>

          <button onclick="goToAssignment()" id="continueToAssignment" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
            Continue to Assignment
          </button>
        </div>

        <!-- Assignment State -->
        <div id="assignmentState" class="hidden">
          <div class="px-6 pt-6 pb-3">
            <button onclick="showState('partySetupState')" class="mb-3 text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1">
              ‚Üê Back
            </button>
          </div>

          <div class="sticky top-0 bg-white z-10 px-6 py-2 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Assign Items</h3>

            <div class="bg-gray-100 rounded-lg p-2 flex justify-between items-center text-sm mb-2">
              <div class="flex flex-col items-center flex-1">
                <span class="font-bold text-lg text-gray-800" id="totalItemsCount">0</span>
                <span class="text-gray-600 text-xs">Total</span>
              </div>
              <div class="flex flex-col items-center flex-1 border-l border-r border-gray-300">
                <span class="font-bold text-lg text-green-600" id="allocatedCount">0</span>
                <span class="text-gray-600 text-xs">Allocated</span>
              </div>
              <div class="flex flex-col items-center flex-1">
                <span class="font-bold text-lg text-red-600" id="unallocatedCount">0</span>
                <span class="text-gray-600 text-xs">Unallocated</span>
              </div>
            </div>
          </div>

          <div class="p-6 pt-3">
            <div id="assignmentItems" class="space-y-3 mb-6">
              <!-- Items will be inserted here for assignment -->
            </div>

            <button onclick="viewSummary()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all">
              View Summary
            </button>
          </div>
        </div>

        <!-- Summary State -->
        <div id="summaryState" class="hidden p-6">
          <button onclick="showState('assignmentState')" class="mb-4 text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1">
            ‚Üê Back
          </button>
          
          <div id="unallocatedWarning" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4 text-center font-semibold">
            ‚ö† NOT ALL ITEMS ALLOCATED
          </div>
          
          <div class="mb-6" id="summaryContent">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Split Summary</h3>
            <div id="summaryList" class="space-y-3 mb-6">
              <!-- Summary will be shown here -->
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="exportSummary()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-all">
              üì• Export as Image
            </button>
            <button onclick="startOver()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all">
              Split Another Bill
            </button>
          </div>
        </div>

      </div>

    </div>
  </div>

  <script>
    let currentImageData = null;
    let billImages = []; // Array to store multiple cropped images
    let cropper = null;
    let billItems = [];
    let people = [];
    let itemAssignments = {}; // { itemIndex: [personIndexes] }
    let sessionApiKey = null; // Temporary storage for current session only

    // On load, go straight to initial state (no API key check)
    window.addEventListener('DOMContentLoaded', function() {
      showState('initialState');
    });

    function saveApiKey() {
      const input = document.getElementById('apiKeyInput');
      const apiKey = input.value.trim();
      
      if (!apiKey) {
        alert('Please enter an API key');
        return;
      }
      
      if (!apiKey.startsWith('sk-ant-')) {
        alert('Invalid API key format. Anthropic API keys start with "sk-ant-"');
        return;
      }
      
      // Store only in session, not localStorage
      sessionApiKey = apiKey;
      input.value = '';
      
      // Continue with analysis
      proceedWithAnalysis();
    }

    function showApiKeySettings() {
      // This function is no longer needed but keeping for compatibility
    }

    function triggerCamera() {
      document.getElementById('fileInput').click();
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          currentImageData = event.target.result;
          showCropInterface();
        };
        reader.readAsDataURL(file);
      }
      // Reset file input for next upload
      e.target.value = '';
    });

    function showCropInterface() {
      const cropperImg = document.getElementById('cropperImage');
      cropperImg.src = currentImageData;
      
      showState('cropState');
      
      // Initialize cropper after a small delay to ensure image is loaded
      setTimeout(() => {
        if (cropper) {
          cropper.destroy();
        }
        cropper = new Cropper(cropperImg, {
          aspectRatio: NaN, // Free aspect ratio
          viewMode: 1,
          guides: true,
          center: true,
          highlight: true,
          background: false,
          autoCropArea: 1,
          responsive: true
        });
      }, 100);
    }

    function cancelCrop() {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      currentImageData = null;
      
      // Go back to appropriate state
      if (billImages.length > 0) {
        showState('imageManagementState');
      } else {
        showState('initialState');
      }
    }

    function saveCrop() {
      if (!cropper) return;
      
      // Get cropped canvas
      const canvas = cropper.getCroppedCanvas({
        maxWidth: 2048,
        maxHeight: 2048,
        fillColor: '#fff',
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
      });
      
      // Convert to base64
      const croppedImageData = canvas.toDataURL('image/jpeg', 0.9);
      
      // Add to images array
      billImages.push(croppedImageData);
      
      // Cleanup
      cropper.destroy();
      cropper = null;
      currentImageData = null;
      
      // Show image management state
      updateUploadedImagesGrid();
      showState('imageManagementState');
    }

    function updateUploadedImagesGrid() {
      const grid = document.getElementById('uploadedImagesGrid');
      const analyzeBtn = document.getElementById('analyzeAllBtn');
      
      grid.innerHTML = '';
      
      billImages.forEach((imgData, index) => {
        const imgDiv = document.createElement('div');
        imgDiv.className = 'relative bg-gray-100 rounded-lg overflow-hidden aspect-square';
        imgDiv.innerHTML = `
          <img src="${imgData}" class="w-full h-full object-cover">
          <button onclick="removeImage(${index})" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 font-bold">
            √ó
          </button>
          <div class="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">
            Image ${index + 1}
          </div>
        `;
        grid.appendChild(imgDiv);
      });
      
      // Enable analyze button if we have images
      analyzeBtn.disabled = billImages.length === 0;
    }

    function removeImage(index) {
      billImages.splice(index, 1);
      updateUploadedImagesGrid();
      
      // If no images left, go back to initial state
      if (billImages.length === 0) {
        showState('initialState');
      }
    }

    function resetImages() {
      billImages = [];
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
    }

    function showState(stateId) {
      const states = ['apiKeySetupState', 'initialState', 'loadingState', 'cropState', 'imageManagementState', 'resultsState', 'partySetupState', 'assignmentState', 'summaryState'];
      states.forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(stateId).classList.remove('hidden');
    }

    function retakeBill() {
      resetImages();
      showState('initialState');
    }

    function analyzeAllImages() {
      if (billImages.length === 0) {
        alert('No images to analyze');
        showState('initialState');
        return;
      }
      
      // Always ask for API key before analysis
      sessionApiKey = null;
      showState('apiKeySetupState');
    }

    async function proceedWithAnalysis() {
      showState('loadingState');

      if (!sessionApiKey) {
        alert('API key not found. Please enter your API key.');
        showState('apiKeySetupState');
        return;
      }

      if (billImages.length === 0) {
        alert('No images to analyze');
        showState('initialState');
        return;
      }

      try {
        // Build content array with all images
        const contentBlocks = [];
        
        billImages.forEach((imageData, index) => {
          const base64Image = imageData.split(',')[1];
          const imageType = imageData.split(';')[0].split('/')[1];
          
          contentBlocks.push({
            type: 'image',
            source: {
              type: 'base64',
              media_type: `image/${imageType}`,
              data: base64Image
            }
          });
        });

        // Add the text instruction
        contentBlocks.push({
          type: 'text',
          text: `I've uploaded ${billImages.length} image${billImages.length > 1 ? 's' : ''} of a restaurant bill. These images may show different sections of the same bill. Analyze all images together and extract all the line items with their prices.
          
Return ONLY a valid JSON array with this exact format:
[
  {"name": "Item name", "price": 12.50},
  {"name": "Another item", "price": 8.00}
]

Rules:
- Combine information from ALL images - they're parts of the same bill
- Extract ONLY food and drink items, not taxes, tips, service charges, or totals
- Use the exact item names from the bill
- Prices must be numbers (not strings)
- If you see quantities (e.g., "2x Beer"), create separate items for each
- Do not include any text before or after the JSON array
- Make sure the JSON is valid and parseable
- Don't duplicate items that appear in multiple images`
        });

        // Call Claude API
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': sessionApiKey,
            'anthropic-version': '2023-06-01'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 2048,
            messages: [{
              role: 'user',
              content: contentBlocks
            }]
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || `API error: ${response.status}`);
        }

        const data = await response.json();
        const textContent = data.content.find(block => block.type === 'text')?.text;
        
        if (!textContent) {
          throw new Error('No text response from Claude');
        }

        // Parse the JSON response
        const cleanedJson = textContent.trim().replace(/```json\n?|\n?```/g, '');
        billItems = JSON.parse(cleanedJson);

        if (!Array.isArray(billItems) || billItems.length === 0) {
          throw new Error('No items found in the bill');
        }

        displayResults(billItems);

      } catch (error) {
        console.error('Analysis error:', error);
        alert(`Failed to analyze bill: ${error.message}\n\nPlease try again or add items manually.`);
        
        // Show empty results page so user can add items manually
        billItems = [];
        displayResults(billItems);
      }
    }

    function displayResults(items) {
      const container = document.getElementById('billItems');
      container.innerHTML = '';
      
      updateCalculatedTotal();
      
      billItems.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'bg-white border border-gray-200 rounded-lg p-4 flex justify-between items-center';
        itemDiv.innerHTML = `
          <div>
            <p class="font-medium text-gray-800">${item.name}</p>
          </div>
          <div class="text-right flex items-center gap-2">
            <p class="font-semibold text-gray-900">R${item.price.toFixed(2)}</p>
            <button onclick="removeItem(${index})" class="text-red-500 hover:text-red-700 font-bold text-xl">√ó</button>
          </div>
        `;
        container.appendChild(itemDiv);
      });

      showState('resultsState');
    }

    function addManualItem() {
      const nameInput = document.getElementById('manualItemName');
      const priceInput = document.getElementById('manualItemPrice');
      const qtyInput = document.getElementById('manualItemQty');
      
      const name = nameInput.value.trim();
      const price = parseFloat(priceInput.value);
      const qty = parseInt(qtyInput.value) || 1;
      
      if (name && price > 0 && qty > 0) {
        // Add separate items for each quantity
        for (let i = 0; i < qty; i++) {
          billItems.push({ name, price });
        }
        nameInput.value = '';
        priceInput.value = '';
        qtyInput.value = '1';
        displayResults(billItems);
      } else {
        alert('Please enter item name, valid price, and quantity');
      }
    }

    function removeItem(index) {
      billItems.splice(index, 1);
      displayResults(billItems);
    }

    function updateCalculatedTotal() {
      let total = 0;
      billItems.forEach(item => {
        total += item.price;
      });
      document.getElementById('totalAmount').textContent = `R${total.toFixed(2)}`;
      validateBillTotal();
      return total;
    }

    function validateBillTotal() {
      const billTotalInput = document.getElementById('billTotalInput');
      const messageDiv = document.getElementById('totalComparisonMessage');
      const continueBtn = document.getElementById('continueToSplitBtn');
      
      const enteredTotal = parseFloat(billTotalInput.value);
      const calculatedTotal = billItems.reduce((sum, item) => sum + item.price, 0);
      
      if (!enteredTotal || enteredTotal <= 0) {
        messageDiv.innerHTML = '';
        continueBtn.disabled = true;
        return;
      }
      
      const difference = Math.abs(enteredTotal - calculatedTotal);
      
      if (difference < 0.01) {
        messageDiv.innerHTML = '<span class="text-green-600 font-medium">‚úì Totals match!</span>';
        continueBtn.disabled = false;
      } else if (calculatedTotal < enteredTotal) {
        messageDiv.innerHTML = `<span class="text-red-600 font-medium">‚ö† Items total R${calculatedTotal.toFixed(2)} - Missing R${difference.toFixed(2)}</span>`;
        continueBtn.disabled = true;
      } else {
        messageDiv.innerHTML = `<span class="text-red-600 font-medium">‚ö† Items total R${calculatedTotal.toFixed(2)} - Over by R${difference.toFixed(2)}</span>`;
        continueBtn.disabled = true;
      }
    }

    function goToPartySetup() {
      people = [];
      itemAssignments = {};
      document.getElementById('peopleList').innerHTML = '';
      document.getElementById('personNameInput').value = '';
      showState('partySetupState');
    }

    function addPerson() {
      const input = document.getElementById('personNameInput');
      const name = input.value.trim();
      
      if (name) {
        people.push(name);
        input.value = '';
        updatePeopleList();
        updateContinueButton();
        input.focus(); // Auto-focus back to input
      }
    }

    function updatePeopleList() {
      const container = document.getElementById('peopleList');
      container.innerHTML = '';
      
      people.forEach((person, index) => {
        const personDiv = document.createElement('div');
        personDiv.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 flex justify-between items-center';
        personDiv.innerHTML = `
          <span class="font-medium text-gray-800">${person}</span>
          <button onclick="removePerson(${index})" class="text-red-500 hover:text-red-700 font-bold text-xl">√ó</button>
        `;
        container.appendChild(personDiv);
      });
    }

    function removePerson(index) {
      people.splice(index, 1);
      updatePeopleList();
      updateContinueButton();
    }

    function updateContinueButton() {
      const btn = document.getElementById('continueToAssignment');
      btn.disabled = people.length < 2;
    }

    function goToAssignment() {
      if (people.length < 2) return;
      
      // Initialize assignments
      billItems.forEach((item, index) => {
        if (!itemAssignments[index]) {
          itemAssignments[index] = [];
        }
      });
      
      displayAssignmentItems();
      showState('assignmentState');
    }

    function displayAssignmentItems() {
      const container = document.getElementById('assignmentItems');
      container.innerHTML = '';
      
      let allocatedCount = 0;
      let unallocatedCount = 0;
      
      billItems.forEach((item, itemIndex) => {
        const isAssigned = itemAssignments[itemIndex].length > 0;
        const bgColor = isAssigned ? 'bg-green-200' : 'bg-red-200';
        
        if (isAssigned) {
          allocatedCount++;
        } else {
          unallocatedCount++;
        }
        
        const itemDiv = document.createElement('div');
        itemDiv.className = `${bgColor} border border-gray-300 rounded-lg p-4`;
        
        let assignedNames = itemAssignments[itemIndex]
          .map(personIndex => people[personIndex])
          .join(', ');
        
        if (!assignedNames) {
          assignedNames = 'Not assigned';
        }
        
        itemDiv.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div>
              <p class="font-medium text-gray-800">${item.name}</p>
              <p class="text-sm text-gray-600">R${item.price.toFixed(2)}</p>
            </div>
          </div>
          <div class="mb-2">
            <p class="text-xs text-gray-500 mb-2">Assigned to: <span class="font-medium">${assignedNames}</span></p>
          </div>
          <div class="flex flex-wrap gap-2" id="peopleButtons-${itemIndex}">
            ${people.map((person, personIndex) => `
              <button 
                onclick="toggleAssignment(${itemIndex}, ${personIndex})"
                class="px-3 py-1 rounded-full text-sm font-medium transition-all ${
                  itemAssignments[itemIndex].includes(personIndex)
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }"
              >
                ${person}
              </button>
            `).join('')}
          </div>
        `;
        
        container.appendChild(itemDiv);
      });
      
      // Update counter
      document.getElementById('totalItemsCount').textContent = billItems.length;
      document.getElementById('allocatedCount').textContent = allocatedCount;
      document.getElementById('unallocatedCount').textContent = unallocatedCount;
    }

    function toggleAssignment(itemIndex, personIndex) {
      if (itemAssignments[itemIndex].includes(personIndex)) {
        itemAssignments[itemIndex] = itemAssignments[itemIndex].filter(p => p !== personIndex);
      } else {
        itemAssignments[itemIndex].push(personIndex);
      }
      displayAssignmentItems();
    }

    function viewSummary() {
      const container = document.getElementById('summaryList');
      container.innerHTML = '';
      
      // Check if all items are allocated
      let hasUnallocated = false;
      billItems.forEach((item, itemIndex) => {
        if (itemAssignments[itemIndex].length === 0) {
          hasUnallocated = true;
        }
      });
      
      // Show/hide warning
      const warningDiv = document.getElementById('unallocatedWarning');
      if (hasUnallocated) {
        warningDiv.classList.remove('hidden');
      } else {
        warningDiv.classList.add('hidden');
      }
      
      // Calculate base totals per person
      const personBaseTotals = people.map(() => 0);
      
      billItems.forEach((item, itemIndex) => {
        const assignedPeople = itemAssignments[itemIndex];
        if (assignedPeople.length > 0) {
          const splitAmount = item.price / assignedPeople.length;
          assignedPeople.forEach(personIndex => {
            personBaseTotals[personIndex] += splitAmount;
          });
        }
      });
      
      // Display each person's summary with tip options
      people.forEach((person, index) => {
        const baseTotal = personBaseTotals[index];
        
        const personDiv = document.createElement('div');
        personDiv.className = 'bg-white border-2 border-gray-300 rounded-lg p-4';
        personDiv.innerHTML = `
          <div class="mb-3">
            <h4 class="text-lg font-bold text-gray-800 mb-2">${person}</h4>
            
            <div class="space-y-1 mb-3">
              ${billItems.map((item, itemIndex) => {
                if (itemAssignments[itemIndex].includes(index)) {
                  const splitCount = itemAssignments[itemIndex].length;
                  const amount = item.price / splitCount;
                  return `
                    <div class="flex justify-between text-sm">
                      <span class="text-gray-600">${item.name}${splitCount > 1 ? ` (split ${splitCount} ways)` : ''}</span>
                      <span class="text-gray-800">R${amount.toFixed(2)}</span>
                    </div>
                  `;
                }
                return '';
              }).join('')}
              <div class="flex justify-between text-sm font-semibold pt-2 border-t border-gray-200">
                <span class="text-gray-700">Subtotal</span>
                <span class="text-gray-900">R${baseTotal.toFixed(2)}</span>
              </div>
              <div class="flex justify-between text-sm" id="tip-display-${index}">
                <span class="text-gray-600">Tip (<span id="tip-percent-${index}">0</span>%)</span>
                <span class="text-gray-800" id="tip-amount-${index}">R0.00</span>
              </div>
            </div>
            
            <div class="flex justify-between items-center pt-2 mb-3 border-t-2 border-gray-300">
              <span class="text-lg font-bold text-gray-800">Total</span>
              <span class="text-2xl font-bold text-blue-600" id="total-${index}">R${baseTotal.toFixed(2)}</span>
            </div>
            
            <div>
              <p class="text-xs font-medium text-gray-600 mb-2">Select Tip:</p>
              <div class="flex gap-2">
                <button onclick="setTip(${index}, 0.10)" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all bg-gray-200 text-gray-700 hover:bg-blue-600 hover:text-white tip-btn-${index}" data-tip="10">
                  10%
                </button>
                <button onclick="setTip(${index}, 0.15)" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all bg-gray-200 text-gray-700 hover:bg-blue-600 hover:text-white tip-btn-${index}" data-tip="15">
                  15%
                </button>
                <button onclick="setTip(${index}, 0.20)" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all bg-gray-200 text-gray-700 hover:bg-blue-600 hover:text-white tip-btn-${index}" data-tip="20">
                  20%
                </button>
              </div>
            </div>
          </div>
        `;
        container.appendChild(personDiv);
      });
      
      showState('summaryState');
    }

    function setTip(personIndex, tipPercent) {
      // Calculate base total for this person
      let baseTotal = 0;
      billItems.forEach((item, itemIndex) => {
        const assignedPeople = itemAssignments[itemIndex];
        if (assignedPeople.includes(personIndex)) {
          const splitAmount = item.price / assignedPeople.length;
          baseTotal += splitAmount;
        }
      });
      
      const tipAmount = baseTotal * tipPercent;
      const totalWithTip = baseTotal + tipAmount;
      
      // Update tip display
      const tipPercentDisplay = document.getElementById(`tip-percent-${personIndex}`);
      const tipAmountDisplay = document.getElementById(`tip-amount-${personIndex}`);
      const totalDisplay = document.getElementById(`total-${personIndex}`);
      
      tipPercentDisplay.textContent = (tipPercent * 100).toFixed(0);
      tipAmountDisplay.textContent = `R${tipAmount.toFixed(2)}`;
      totalDisplay.textContent = `R${totalWithTip.toFixed(2)}`;
      
      // Update button styles
      const buttons = document.querySelectorAll(`.tip-btn-${personIndex}`);
      buttons.forEach(btn => {
        if (btn.getAttribute('data-tip') === (tipPercent * 100).toFixed(0)) {
          btn.classList.remove('bg-gray-200', 'text-gray-700');
          btn.classList.add('bg-blue-600', 'text-white');
        } else {
          btn.classList.remove('bg-blue-600', 'text-white');
          btn.classList.add('bg-gray-200', 'text-gray-700');
        }
      });
    }

    function startOver() {
      currentImageData = null;
      billItems = [];
      people = [];
      itemAssignments = {};
      sessionApiKey = null; // Clear API key for next bill
      document.getElementById('fileInput').value = '';
      showState('initialState');
    }

    async function exportSummary() {
      const summaryContent = document.getElementById('summaryContent');
      
      try {
        // Use html2canvas to capture the summary
        const canvas = await html2canvas(summaryContent, {
          backgroundColor: '#ffffff',
          scale: 2, // Higher quality
          logging: false
        });
        
        // Convert to blob and download
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          const date = new Date().toISOString().split('T')[0];
          link.download = `bill-split-summary-${date}.png`;
          link.href = url;
          link.click();
          URL.revokeObjectURL(url);
        });
      } catch (error) {
        console.error('Export failed:', error);
        alert('Failed to export summary. Please try again.');
      }
    }
  </script>
</body>
</html>